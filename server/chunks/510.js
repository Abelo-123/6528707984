"use strict";exports.id=510,exports.ids=[510],exports.modules={2790:(e,t,s)=>{s.d(t,{Z:()=>l});var r=s(4588);s(5666);var a=s(7302);let l=e=>(0,r.jsxs)(a.ZP,{speed:2,width:476,height:124,viewBox:"0 0 476 124",backgroundColor:"var(--tgui--bg_color)",foregroundColor:"#ecebeb",...e,children:[(0,r.jsx)("rect",{x:"-1",y:"105",rx:"3",ry:"3",width:"357",height:"12"}),(0,r.jsx)("rect",{x:"-2",y:"46",rx:"3",ry:"3",width:"373",height:"12"}),(0,r.jsx)("rect",{x:"0",y:"75",rx:"3",ry:"3",width:"363",height:"13"}),(0,r.jsx)("rect",{x:"0",y:"16",rx:"3",ry:"3",width:"380",height:"12"})]})},4768:(e,t,s)=>{s.r(t),s.d(t,{default:()=>m});var r=s(4588),a=s(6091),l=s(5666),i=s(8387),o=s(8653),n=s(8284),d=s(2790),c=s(7805),u=s(3506),x=s(6532),p=s(7668);let m=()=>{let[e,t]=(0,l.useState)(null),[s,m]=(0,l.useState)(!1),[f,h]=(0,l.useState)({}),[g,w]=(0,l.useState)({}),{useNotification:y,setNotification:b}=(0,n.a)(),[j,v]=(0,l.useState)(null),[N,k]=(0,l.useState)([]),[S,C]=(0,l.useState)(!1),_=async e=>{let t=N.find(t=>String(t.oid)===String(e));if(!t||"refunded"===t.status){console.log(`Skipping fetchOrderStatus for order ${e}, status is "refunded" or order not found.`);return}if("refunded"===t.status){console.log(`Skipping API call for order ${e}, status is "refunded".`);return}if("Completed"===t.status||"Canceled"===t.status){console.log(`Skipping API call for order ${e}, status is already '${t.status}'.`);return}try{let t=(await o.Z.post("../../api/smm/fetchStatus",{orderId:e})).data;if(t.status){let{status:s,start_count:r,remains:a}=t;k(s=>s.map(s=>s.oid===e?{...s,status:t.status,start_count:t.start_count,remains:t.remains}:s))}}catch(e){console.error("Failed to fetch order status:",e),o.Z.isAxiosError(e)&&console.error("Axios error:",e.response?.data||e.message)}},P=async(e,t)=>{if(S){console.log("Already fetching statuses, skipping...");return}C(!0);let s=[...e.filter(e=>["Pending","In progress","Processing","Partial"].includes(e.status))],r=[],a=async()=>{for(;s.length>0;){let e=s.shift();e&&await _(e.oid)}};for(let e=0;e<t;e++)r.push(a());await Promise.all(r),C(!1)};(0,l.useEffect)(()=>{let e=document.createElement("script");e.src="https://telegram.org/js/telegram-web-app.js?2",e.async=!0,document.body.appendChild(e),e.onload=async()=>{let e=window.Telegram;if(e.WebApp.expand(),window.Telegram&&window.Telegram.WebApp){window.Telegram.WebApp.ready();let{user:t}=e.WebApp.initDataUnsafe;v(t.id)}}},[]),(0,l.useEffect)(()=>{let e=localStorage.getItem("refillCooldowns"),t=Date.now(),s={};e&&(s=Object.fromEntries(Object.entries(JSON.parse(e)).filter(([e,s])=>s>t))),h(s)},[]),(0,l.useEffect)(()=>{localStorage.setItem("refillCooldowns",JSON.stringify(f))},[f]),(0,l.useEffect)(()=>{let e=setInterval(()=>{h(e=>{let t={...e};return Object.keys(t).forEach(e=>{void 0!==t[e]&&t[e]<=Date.now()&&delete t[e]}),t})},1e3);return()=>clearInterval(e)},[]);let $=async e=>{if(void 0!==f[e]){console.log(`Cooldown is already set for order ${e}.`);return}w(t=>({...t,[e]:!0}));try{let t=await fetch(`/api/refill?order=${e}`,{method:"GET"}),s=await t.json();if("Refill is disabled for this service"===s.error){p.Z.fire({icon:"error",title:"Refill Disabled",text:"Refill is disabled for this service."});return}if("The order was completed or refill was requested less than 24 hours ago"===s.error){p.Z.fire({icon:"warning",title:"Refill Not Allowed",text:"Try requesting after 24 hours"});return}let r=Date.now();h(t=>{let s={...t,[e]:r+864e5};return localStorage.setItem("refillCooldowns",JSON.stringify(s)),s}),console.log(`Refill requested for order ${e}`)}catch(t){console.error(`Failed to request refill for order ${e}:`,t)}finally{w(t=>({...t,[e]:!1}))}},E=e=>{let t=f[e];if(!t)return{hours:0,minutes:0,seconds:0};let s=Math.max(0,t-Date.now());return{hours:Math.floor(s/1e3/60/60),minutes:Math.floor(s/1e3/60%60),seconds:Math.floor(s/1e3%60)}},[I,D]=(0,l.useState)(null),[O,R]=(0,l.useState)(null),T=e=>{D(I===e?null:e)},A=e=>{R(O===e?null:e)};return(0,l.useEffect)(()=>{(async()=>{m(!0);let{data:e,error:t}=await i.O.from("orders").select("*").eq("uid",j).order("created",{ascending:!1});t?console.log(t):(k(e),m(!1))})()},[j]),(0,l.useEffect)(()=>{N.length>0&&P(N.filter(e=>["Pending","In progress","Processing","Partial"].includes(e.status)),3)},[N,P]),(0,l.useEffect)(()=>{let e=i.O.channel("orders_channel").on("postgres_changes",{event:"INSERT",schema:"public",table:"orders",filter:"uid=eq.393383708"},e=>{k(t=>[e.new,...t]),"Completed"!==e.new.status&&"Canceled"!==e.new.status&&"refunded"!==e.new.status&&_(e.new.oid)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"orders",filter:"uid=eq.393383708"},e=>{k(t=>t.map(t=>t.oid===e.new.oid?{...t,status:e.new.status,start_count:e.new.start_from,remains:e.new.remains}:t)),["Pending","In progress","Processing","Partial"].includes(e.new.status)&&!["Cancelled","Completed"].includes(e.new.status)&&_(e.new.oid)}).subscribe();return()=>{e.unsubscribe()}},[_]),(0,l.useEffect)(()=>{(async()=>{let e=N.filter(e=>"Canceled"===e.status&&e.uid===j&&"refunded"!==e.status);if(0===e.length){console.log("No eligible canceled items found for user 6528707984.");return}for(let t of e){console.log("Refunding:",t.oid);let{error:e}=await i.O.from("orders").update({status:"refunded"}).eq("oid",t.oid);if(e){console.error(`Failed to update status for order ${t.oid}:`,e);continue}console.log(`Order ${t.oid} status updated to "refunded" in database.`),k(e=>e.map(e=>e.oid===t.oid?{...e,status:"refunded"}:e));let{data:s,error:r}=await i.O.from("users").select("balance").eq("id",t.uid).single();if(r){console.error(`Failed to fetch balance for user ${t.uid}:`,r);continue}let a=s?.balance||0,{error:l}=await i.O.from("users").update({balance:t.charge+a}).eq("id",t.uid);l?console.error(`Failed to refund charge for user ${t.uid}:`,l):console.log(`Refunded ${t.charge} to user ${t.uid}'s balance.`)}})()},[N]),(0,l.useEffect)(()=>{let e=e=>{let t=e.detail;k(e=>[t,...e])};return window.addEventListener("newOrder",e),()=>{window.removeEventListener("newOrder",e)}},[]),(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)(a.aV,{style:{padding:"0px 0px"},children:[y.notificationModal&&(0,r.jsxs)("div",{style:{zIndex:900,background:"var(--tgui--section_bg_color)"},className:" modal-popp fixed inset-0 top-0 bottom-0 w-screen ",children:[y.notificationLoader&&(0,r.jsx)(d.Z,{style:{marginTop:"2rem"}}),(0,r.jsx)("div",{style:{height:"85%"},className:"mt-2 ",children:(0,r.jsx)("div",{className:"  w-screen ",children:!y.notifcationLoader&&y.notificationData&&y.notificationData.map((e,t)=>(0,r.jsx)("li",{className:"flex w-11/12 p-3 mx-auto",style:{borderTop:"2px solid black"},children:(0,r.jsxs)("div",{className:"block w-full px-2",children:[(0,r.jsxs)("div",{className:"text-right ml-auto",children:[" ",e.from]}),(0,r.jsxs)("div",{className:"text ml-2",children:[" ",e.message]})]})},t))})}),(0,r.jsx)("div",{className:"absolute  w-full grid place-content-center bottom-4",children:(0,r.jsxs)("div",{onClick:()=>{b(e=>({...e,notificationModal:!1,notificationData:[],notificationLoader:!0}))},className:"p-3 ",children:[(0,r.jsx)(u.G,{icon:c.ptP,style:{margin:"auto auto",color:"var(--tgui--section_header_text_color)"},size:"2x"}),(0,r.jsx)(a.xv,{style:{display:"inline",margin:"auto 0.5rem",fontWeight:"700",color:"var(--tgui--section_header_text_color)"},children:"Back"})]})})]}),(0,r.jsx)("div",{className:"z-90   w-full absolute place-content-center grid place-content-end absolute  ",onClick:()=>window.location.href="https://www.google.com",style:{margin:"1rem -0.9rem",fontSize:"0.8rem",height:"3rem",zIndex:900},children:(0,r.jsxs)("div",{className:"flex",style:{zIndex:1},children:[(0,r.jsx)(u.G,{icon:x.Uv8,style:{margin:"1.3rem 0.3rem",color:"var(--tgui--section_header_text_color)"},size:"2x"}),(0,r.jsx)("div",{className:"font-sans inline mx-auto my-auto",children:"Support"})]})}),(0,r.jsx)(a.$0,{header:(0,r.jsx)(r.Fragment,{children:(0,r.jsx)("div",{className:"tgui-c3e2e598bd70eee6 tgui-080a44e6ac3f4d27 tgui-d0251b46536ac046 tgui-809f1f8a3f64154d tgui-266b6ffdbad2b90e tgui-8f63cd31b2513281 tgui-9c200683b316fde6",children:"Order history"})}),style:{marginTop:"-0.5rem",border:"1px solid var(--tgui--section_bg_color)"},children:(0,r.jsxs)("div",{style:{width:"100%"},className:" mx-auto",children:[s&&(0,r.jsx)(d.Z,{}),(0,r.jsx)("div",{style:{borderRadius:"10px",height:"31rem",width:"100%"},className:"scrollabler  w-full overflow-x-auto",children:!s&&(0,r.jsxs)("table",{style:{width:"100%"},className:"   rounded-lg shadow-md",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium  uppercase tracking-wider text-nowrap",children:"Status"}),(0,r.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium uppercase tracking-wider",children:"ID"}),(0,r.jsx)("th",{className:"px-6 py-3 text-nowrap text-left text-xs font-medium  uppercase tracking-wider",children:"Starting From"}),(0,r.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium  uppercase tracking-wider",children:"Quantity"}),(0,r.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium  uppercase tracking-wider",children:"Remains"}),(0,r.jsx)("th",{className:"px-6 py-3 text-sm text-nowrap",children:"Link"}),(0,r.jsx)("th",{className:"px-6 py-3 text-nowrap text-left text-xs font-medium  uppercase tracking-wider",children:"Charge (ETB)"}),(0,r.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium  uppercase tracking-wider text-nowrap",children:"Service"}),(0,r.jsx)("th",{className:"px-6 py-3 text-nowrap text-left text-xs font-medium  uppercase tracking-wider",children:"Refill"}),(0,r.jsx)("th",{className:"px-6 py-3 text-left text-xs font-medium  uppercase tracking-wider text-nowrap",children:"Date"})]})}),(0,r.jsx)("tbody",{className:" ",children:N.map((e,t)=>{let s=I===t,a=e.link.length>20?`${e.link.substring(0,20)}...`:e.link;return(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{style:{textShadow:"Canceled"===e.status?"2px 2px 29px red":"Completed"===e.status?"2px 2px 29px lime":"Pending"===e.status?"2px 2px 29px yellow":"In progress"===e.status?"2px 2px 29px blue":"Processing"===e.status?"2px 2px 29px blue":"Partial"===e.status?"2px 2px 29px blue":"refunded"===e.status?"2px 2px 29px red":void 0},className:"px-6 py-4 text-sm text-nowrap",children:e.status}),(0,r.jsx)("td",{className:"px-6 py-4 text-sm ",children:e.oid}),(0,r.jsx)("td",{className:"px-6 py-4 text-sm ",children:e.start_from}),(0,r.jsx)("td",{className:"px-6 py-4 text-sm ",children:e.uid}),(0,r.jsx)("td",{className:"px-6 py-4 text-sm ",children:e.remains}),(0,r.jsx)("td",{className:"px-6 py-4 text-sm",children:(0,r.jsxs)("div",{style:{display:"flex"},children:[(0,r.jsxs)("span",{className:"flex",children:[e.link&&(()=>{try{let t=new URL(e.link);return(0,r.jsx)("a",{href:t.href,target:"_blank",rel:"noopener noreferrer",style:{display:"inline-block",marginRight:"0.5rem"},children:(0,r.jsx)(u.G,{icon:c.nNP,style:{margin:"auto",color:"var(--tgui--section_header_text_color)"},size:"1x"})})}catch(e){return(0,r.jsx)("span",{style:{color:"red"},children:"Invalid Link"})}})(),(0,r.jsx)("span",{children:s?e.link:a})]}),e.link.length>20&&(0,r.jsx)("button",{style:{display:"inline"},onClick:()=>T(t),className:"text-blue-500 hover:underline ml-2",children:s?"See less":"See more"})]})}),(0,r.jsx)("td",{className:"px-6 py-4 text-sm ",children:e.charge}),(0,r.jsxs)("td",{className:"px-6 py-4 text-sm text-nowrap ",children:[(0,r.jsx)("span",{children:O===t?e.name:e.name.length>20?`${e.name.substring(0,20)}...`:e.name}),e.name.length>20&&(0,r.jsx)("button",{onClick:()=>A(t),className:"text-blue-500 hover:underline ml-2",children:O===t?"See less":"See more"})]}),(0,r.jsx)("td",{className:"px-6 py-4 text-sm text-nowrap ",children:e.refill&&(0,r.jsx)(r.Fragment,{children:(0,r.jsx)("button",{onClick:t=>{t.stopPropagation(),void 0===f[e.oid]&&"Completed"===e.status?$(e.oid):f[e.oid]&&console.log(`Cooldown already active for order ${e.oid}.`)},style:{backgroundColor:g[e.oid]?"orange":f[e.oid]>Date.now()?"gray":"Completed"===e.status&&void 0===f[e.oid]?"blue":"rgba(0, 0, 0, 0.5)",color:"white",padding:"0.5rem 1rem",borderRadius:"5px",border:"none",cursor:g[e.oid]||f[e.oid]>Date.now()||"Completed"!==e.status?"not-allowed":"pointer"},disabled:g[e.oid]||f[e.oid]>Date.now()||"Completed"!==e.status,children:g[e.oid]?"Loading...":f[e.oid]>Date.now()?`Cooldown (${E(e.oid).minutes}m ${E(e.oid).seconds}s)`:"Refill"})})}),(0,r.jsx)("td",{className:"px-6 py-4 text-sm text-nowrap",children:e.date})]},t)})})]})})]})})]})})}},8483:(e,t,s)=>{s.r(t),s.d(t,{default:()=>a});var r=s(6121);let a=async e=>[{type:"image/x-icon",sizes:"16x16",url:(0,r.fillMetadataSegment)(".",await e.params,"favicon.ico")+""}]}};